
badgesshieldsÀÇ	2017-10-30T03:02:53Z"2017-10-30T03:11:11Z*BFix the cache bug introduced in #1186 that blocked today's deploy.2I
(090454a828c5f98f2ba4edbae761f601b77cf28d2017-10-30T03:11:10Z1487036¡­2018-03-19T03:16:11Z"2018-03-20T23:04:56Z*ÈBreaking invokeHandler into its own function makes it easy to test the error handling, and also to expand the error handling as I've done in this WIP branch: master...paulmelnikow:rewrite-npm-typedefs2I
(71ef474afc8ca7ecbf4a2a6e699fdf024f21dad02018-03-20T23:04:55Z1487036:¤
2018-03-19T03:16:58Z‹Messages
    
  
  
      ğŸ“–
      
âœ¨ Thanks for your contribution to Shields, @paulmelnikow!
  
    
  


  Generated by ğŸš« dangerJS:
2018-03-19T03:34:21ZiAfter this lands I'll open a PR to handle query parameters in BaseService. It'll conflict if I do it now.:-
2018-03-20T23:04:39ZThanks for reviewing!Œ•2018-01-08T20:58:01Z"2018-02-26T00:41:31Z*¸This solves a bug with JSON + style reported in #1348.
The problem occurs then we request for a .json resource with style of an image (e.g. .svg) badge. Why? Because makeBadge (lib/make-badge.js) sets flat as a default value of a badge regardless of a format (there is a flat-template.svg, but not flat-template.json). For request with unknown style (not an image style nor a json style) it was set to default in makeBadgeData (lib/badge-data.js).
We need style (template name) + format to set default value. That is why I removed isValidStyle and I kept only one place where the default values are assigned.
I'm aware that this bug can be resolved in a different manner, so feel free to comment.2I
(6b76a6ef240465eeb0797e3a634378d8c5b030782018-02-26T00:41:30Z1526000:Ú
2018-01-08T20:59:27ZÁWarnings
    
  
  
      âš ï¸
      
This PR modified the server but none of the service tests. That's okay so long as it's refactoring existing code.
  
    
  


  
    
      
      Messages
    
  
  
      ğŸ“–
      
âœ¨ Thanks for your contribution to Shields, @platan!
  
    
  


  Generated by ğŸš« dangerJS:S
2018-01-08T22:18:30Z;I've just merged #1419. Could you switch this over to Chai?:1
2018-01-09T20:00:01ZSwitched over to Chai :-):X
2018-01-17T20:41:45Z@@paulmelnikow Is there anything missing here? Can we merge this?:L
2018-02-24T15:17:57Z4@RedSparr0w Could you please take a look at this PR?:F
2018-02-26T00:41:14Z.ğŸ‘
All changes look good to me.
Merged!
ğŸ˜„æ
2017-11-19T23:23:39Z"2017-11-23T05:35:34Z*Closes #1280
was previously trying to convert any numbers to uppercase,

will now convert the label to a string and then to uppercase.

Also removed .toUpperCase() from the template as it shouldn't be needed.
Edit: Updated title as it was breaking the tests2I
(a4bce73da650dde7858532156877eab88fbb59f22017-11-23T05:35:33Z7288322:T
2017-11-20T18:52:35Z<Could you add a unit test for this, maybe in server.spec.js?:²
2017-11-20T20:25:47Z™I just wanted to propose unit test in lib/make-badge.spec.js :-)
  // https://github.com/badges/shields/issues/1280
  it('should produce SVG for "for-the-badge" template with numbers as texts', function () {
    const svg = makeBadge({ text: [1998, 1999], format: 'svg', template: 'for-the-badge' });
    assert(svg.includes('1998'), `${svg} does not contain '1998'`);
    assert(svg.includes('1999'), `${svg} does not contain '1999'`);
  });
or even better using chai assertions (it has contains assertion, we already have chai as a
node-env-flag's dependency):
const chai = require('chai');
chai.should();

...

  // https://github.com/badges/shields/issues/1280
  it('should produce SVG for "for-the-badge" template with numbers as texts', function () {
    const svg = makeBadge({ text: [1998, 1999], format: 'svg', template: 'for-the-badge' });
    svg.should.contains('1998');
    svg.should.contains('1999');
  });:
2017-11-20T21:53:07Z÷Thanks @platan wasn't too sure where to start on the tests!
I'd rather go with your first example as it doesn't depend on a dependencies dependency, and also matches the current tests that is already there.
@paulmelnikow just checking it doesn't need assert.ok(isSvg(svg)); for every tests as its already tested on the first test and should throw there if something is wrong?:£	
2017-11-20T23:58:22ZŠ	I just wanted to propose unit test in lib/make-badge.spec.js :-)

Yeah!

or even better using chai assertions (it has contains assertion, we already have chai as a
node-env-flag's dependency):

I'd be happy to replace Node assert with Chai, which has much richer assertionsâ€¦ though we should make the change across the whole project, declare the dependency, and probably discuss which syntax to use.

@paulmelnikow just checking it doesn't need assert.ok(isSvg(svg)); for every tests as its already tested on the first test and should throw there if something is wrong?

It's not great to throw lots of random extra assertions into a test, though occasionally it can be helpful to establish confidence before making the real assertion. In other words, if you know you have a badge, you can be sure the .contains() check passing means your code is probably working as you intend.
Separating them from the "real" assertions and calling them out with a comment can help express your intent:
// Set up.
prepareSomething();

// Act.
doSomething();

// Confidence check.
assert(something basic, that sets up my test assertions);

// Test.
assert(something specific);:Ÿ
2017-11-22T21:33:32Z†Sweet, this should be ready for merge then if you could please have a quick look over it.
Don't think any other test need to be added.